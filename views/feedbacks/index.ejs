<% layout('layouts/main') -%>

<div class="container-fluid mt-4 feedback-page-container">
    <div class="portfolio-card-container">
        <div class="card mb-4">
            <div class="card-header text-center">
                <h3>Feedback for <%= portfolio.user.fullName %>'s Portfolio</h3>
            </div>
            <div class="card-body text-center">
                <a href="<%= portfolio.url %>" target="_blank">
                    <% if (portfolio.screenshot) { %>
                        <img src="<%= portfolio.screenshot %>" alt="Portfolio Screenshot" class="img-fluid mb-3" style="max-width: 100%; height: auto;">
                    <% } else { %>
                        <img src="/images/defaultscreenshot.svg" alt="Default Screenshot" class="img-fluid mb-3" style="max-width: 100%; height: auto;">
                    <% } %>
                </a>
                <p class="text-muted"><%= portfolio.description %></p>
            </div>
        </div>
        <div class="d-grid">
            <a href="/portfolios/<%= portfolio._id %>/feedbacks/new" class="btn btn-primary">Give Feedback <i class="fas fa-plus ms-1"></i></a>
        </div>
    </div>
    <div class="feedbacks-container">
        <% if (feedbacks.length) { %>
            <% feedbacks.forEach(feedback => { %>
            <div class="card mb-3 feedback-card">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-secondary">by <span class="username-display"><%= feedback.user.username %></span></h6>
                    <% if (feedback.design) { %><p class="card-text"><strong>Design:</strong> <%= feedback.design %></p><% } %>
                    <% if (feedback.responsiveness) { %><p class="card-text"><strong>Responsiveness:</strong> <%= feedback.responsiveness %></p><% } %>
                    <% if (feedback.content) { %><p class="card-text"><strong>Content:</strong> <%= feedback.content %></p><% } %>
                    <% if (feedback.ux_flow) { %><p class="card-text"><strong>UX Flow:</strong> <%= feedback.ux_flow %></p><% } %>
                    <% if (feedback.accessibility) { %><p class="card-text"><strong>Accessibility:</strong> <%= feedback.accessibility %></p><% } %>
                    <% if (feedback.technical_performance) { %><p class="card-text"><strong>Technical Performance:</strong> <%= feedback.technical_performance %></p><% } %>
                    <% if (feedback.additional) { %><p class="card-text"><strong>Additional:</strong> <%= feedback.additional %></p><% } %>
                    <button class="btn btn-sm btn-outline-secondary summarize-btn" data-feedback-id="<%= feedback._id %>">Summarize</button>
                    <div class="summary-container mt-2" id="summary-<%= feedback._id %>"></div>
                </div>
            </div>
            <% }); %>
        <% } else { %>
            <div class="alert alert-info text-center" role="alert">
                No feedback has been submitted for this portfolio yet. Be the first to give some!
            </div>
        <% } %>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const summarizeBtns = document.querySelectorAll('.summarize-btn');
    summarizeBtns.forEach(btn => {
        btn.addEventListener('click', async () => {
            // Disable all buttons
            summarizeBtns.forEach(b => b.disabled = true);

            const feedbackId = btn.dataset.feedbackId;
            const summaryContainer = document.getElementById(`summary-${feedbackId}`);
            summaryContainer.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>';

            try {
                const response = await fetch(`/portfolios/<%= portfolio._id %>/feedbacks/${feedbackId}/summarize`);
                if (!response.ok) {
                    throw new Error('Failed to summarize feedback.');
                }
                const data = await response.json();
                summaryContainer.innerHTML = `<p class="card-text"><strong>Summary:</strong> ${data.summary}</p>`;
            } catch (error) {
                summaryContainer.innerHTML = `<p class="text-danger">${error.message}</p>`;
            } finally {
                // Re-enable all buttons
                summarizeBtns.forEach(b => b.disabled = false);
            }
        });
    });
});
</script>